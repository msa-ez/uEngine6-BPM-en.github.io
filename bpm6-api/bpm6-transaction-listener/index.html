<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>uengine6</title><meta name="gridsome:hash" content="9ad3756725203a158e0c36ac9445e41deb725f5a"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.23"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" data-key="og:url" name="og:url" content="undefined/process-example/sub-process/"><meta data-vue-tag="ssr" name="description" content="undefined"><meta data-vue-tag="ssr" data-key="og:title" name="og:title" content="uEngine6 Transaction Listener"><meta data-vue-tag="ssr" data-key="twitter:title" name="twitter:title" content="uEngine6 Transaction Listener"><meta data-vue-tag="ssr" data-key="og:description" name="og:description" content="undefined"><meta data-vue-tag="ssr" data-key="twitter:description" name="twitter:description" content="undefined"><meta data-vue-tag="ssr" data-key="og:type" name="og:type" content="website"><meta data-vue-tag="ssr" data-key="twitter:card" name="twitter:card" content="summary_large_image"><meta data-vue-tag="ssr" data-key="og:image" name="og:image" content="undefined/logo.jpg"><meta data-vue-tag="ssr" data-key="twitter:image" name="twitter:image" content="undefined/logo.jpg"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.11eb2075e7e73ee87589df7326cf802e.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.11eb2075e7e73ee87589df7326cf802e.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.11eb2075e7e73ee87589df7326cf802e.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.11eb2075e7e73ee87589df7326cf802e.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/assets/static/favicon.62d22cb.11eb2075e7e73ee87589df7326cf802e.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/assets/static/favicon.1539b60.11eb2075e7e73ee87589df7326cf802e.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/assets/static/favicon.dc0cdc5.11eb2075e7e73ee87589df7326cf802e.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/static/favicon.7b22250.11eb2075e7e73ee87589df7326cf802e.png"><link rel="preload" href="/assets/css/0.styles.384da7db.css" as="style"><link rel="preload" href="/assets/js/app.7af9b39f.js" as="script"><link rel="preload" href="/assets/js/page--src-templates-markdown-page-vue.11b18f2f.js" as="script"><link rel="prefetch" href="/assets/js/page--src-pages-404-vue.22cfae0e.js"><link rel="prefetch" href="/assets/js/page--src-pages-index-vue.18f50195.js"><link rel="prefetch" href="/assets/js/search.bcd825f6.js"><link rel="stylesheet" href="/assets/css/0.styles.384da7db.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div data-server-rendered="true" id="app" class="font-sans antialiased text-ui-typo bg-ui-background"><div class="flex flex-col justify-start min-h-screen"><header class="sticky top-0 z-10 w-full border-b bg-ui-background border-ui-border"><div class="py-2 border-t-2 border-ui-primary"><div class="container"><div class="flex items-center justify-between -mx-2 sm:-mx-4"><div class="flex flex-col items-center px-2 mr-auto sm:px-4 sm:flex-row"><a href="/" title="Home" class="flex items-center active"><img src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 2560 805' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-1b8ebebe30c6b760d7467b234995645a'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='40'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-1b8ebebe30c6b760d7467b234995645a)' width='2560' height='805' xlink:href='data:image/png%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAAUCAYAAAA9djs/AAAACXBIWXMAAAsSAAALEgHS3X78AAALQUlEQVRYw71YC1SVVRa%2bPKpZTQ97LQK1qWZyEpQ3EqIIqGRc4Mob7oPXJVIwTEGBi08eJoqiCViDqKBJvp8pCgKCgDwEdSDDJ2Fj3rKslmON3t893zmeq3eYmuVa08xd6/Psf5%2b9z977O/uc/xeZ7H/0i1Gp7o8apfKBHjLTGaERz6Y%2bv/YzrmP0Na73m/0qXKL5uN5NLdviFMll/5mbLBRzt1uGLtxvEZFXbRldcNRSveKYZcyq4xZxa1ot44tPmDM7yDLI/5YoZHOMZiaJmwHmMff0fISN2UMRIOY199Yxf1jifslfM5i47Q5BfFznFicjlESQL4%2bY/FALG0mIL2mTxWjijEmZDQ7%2bnxLVmBQzuDCue9A5ZqYdMbijTP0GxxT2jDgLUwL574DdRD6ywmUn%2bb%2byJ%2bZXm6MDpgfN3aZDB6SjA7LQAVnogEx0QCZ2PQvFO94joc3CpP3NTOS5CLrA5PldYC%2bwBagC9gNhop0fYUmKY2Eu7M1Nu0fIHsBfjPOsIBPZGMfCeDw0D%2bbNfpH9I3aefKxyDOWGm50j4ipdovKYHDhzU1ZUfj1FLTkK1JBqeQPFrGqhuDUnKLnyPIGA7xNK2v7EbDFaKF2eNrL9FBKIRNAzwDKRgC103RivA4sBPyAKGPkrZ978V%2b6VF4HwQXOmpJv/wloWguTJmF%2bH5zwjMXzXd9oH8gX22/o9tsM%2b8NJ2x2Cqcg57lelCdbsq1YXNFLnkSK2qsMFavaJxqKaoaUj8mlZdckUfofCuxDWdj/K7IPtDI9ujEcQXYwuCPi909UAuUA2dy6AjMAX6PPiUYawDxonEg4BDeN4lOuZlYC38Zwm/DGARdJ8C6yE/IfSM2EPwrcaYKOJHiO5zxbw7xkdlLbYOPIFDdl488U9H%2bWS2OAXQntFT6pb5Z/KiVFk7ngrPOXheU9SMDqhPiF3d8iwwDAS8klB8ooWRoC1pr2S2iaXdZjHxSZYiYBESWCEKUeP5KvAq0AR0AgeAd8R8NuRzGJ9FcfmQj/AuUqm%2bALyBYOAiErcE5kDuFjHOAwXQPcd0QDRkeyG/BowAeoEJwA7WcVjXAXjyPvt1I115y9S97vyHGlv3H4%2bOGk8gxJ3p3o/WcRKUBQfGxRY10bT1n9E7685QSsVZmr6hl5LKTtO08l5K3vg5SGhLM2m5PwK9SOZxBPXRsCSVygqxO2dQ5AzoHVmCwj4LcrGYd2ZdAN0o2A0IHVunH7rHeTFKZb3wawNcBRlLgTl8LaXynDhm7wMn%2bV3EulGlWgOswjzbACfZtqdGyprtHDkBTa87bOgb5Ub1rzuXGgv5JiSs8DtFeAKT7VIujfScd8Fr/KIBz/G518YGLT/nm1jS7J9Y2hGVtLbjq5TyM5RU3BzIk1FrShBAJ875WCTFnlnRQ1BMJ2A76AxnsrMpzulYyM1CX4znGs299s8RZEwF6sQ8I8BHyCuBmXheJI7MEHa/AM8DLwHHTeKlwW6jrMPekbd%2b22gHr%2b7RTtRia//tCVunoUzXH6a2vxEcQ%2bc0kV%2bf6lFk0YBPMl32eJsueiTe6fN4ly7Y8i6Rvelu6ZW1p29Kbi1NWnAoaZ6b7GmNSv0NksxmuwO8LFo5BXiGt6RSuZSfe6Uyhukg64BPRIHj4XOavRXYuQa2AR/FPNjpMKBD2J4FJgm5FFgoir4MeOHZCX5%2bwu8IECBkdo8svL8D3c5Ox6%2bMcaMOB8eZRt2lsMTqH0OmUdkH4dKWnlCib6OIrgNXI4i%2biqRv/hpC1PeGrV3awbUeeU3kmLa9kfnFqpR%2bCLwXRbwmgk3kl5RSaSV2OJ9fhCrVHtg1wC5A2EwX9iNgw9rXDHNvs7cI8B7kPozuGP%2bM%2bUXCll2cdmJdFbv8hH6qiMFes9OEbqzQVcGOXbaP80I/83RM%2bts4Nzrt6tR%2bNijwd0zXG54SrZ86i46lxt/JPqqg2fsVV%2buaAjTfdfkH9rfL4/qaFdo7PR7qzNL3VzpmHCS3jN233XX7RjNfl9lbzH%2brr1MUFxMfEzMhTqN5DXIHxin/5Sc6%2b1Z4%2bV%2bUX07ybrgjn0z9Qe6cvdNR2iE9wekXz4enU%2bHHYbcz6xX0UZ2imr4Mcr7aE%2bj5wJMes0/ff9Ejp55c5u6ZwzT2uhqL%2bKhQMzBsjUA2gBUDkrdGIdZvuLpaWT33nI3P%2bPFDY9XqobYjRgx9ZfhwaxRm7ezgYBMRGmrlPW6c9URvbxvYW8EmPyo8vEsVFXUKcqazvf0zkWFhNrC3SYiNtXrmySdt7G1tX0yMj7fCWtY2L7xgDTurEIXCZpiVlc0YFxebtxMSbNTR0VYinxeAp4X8e17G92OjJ9CMN%2bmnUudj/D4IycofUOTS1sWJd9KPBtxd3RBKNwfCiG6g9W9G00BHwC5m55G1Y7tnfhMrnl9ISk28uTiL9oAeAfQo/FqMkJHEtfdSU/X5OTn61JQUNqefp9PpF86fr0eB%2bjmzZ%2btRlP7dlJRrM5KTuT2K/zwvJ6cvbdasvuiIiHPMD8RcY3PMZ%2bmSJfq5aWl6ZWSkPisjQ5%2bzcCHz04MQPfz06bNm6eE3OJevgJtAvuwflaN40jeLnAvw5UPXciZVNPvlXm/SZNCivcFS1hEFVdYoqn44FZA3cFK%2b9FJr4PKbZ7wXqwrLF47OqGXF30L78zPol1zwiCBgDHaI4tRqihVA0oRi6HhTEzXU11NTYyMtLyigthMn6GhtLW2qqKCLFy7QmtWrqaO9nfbs3k2hU6dy3%2bqDBwmFEAqmhro6ykhPpzDMVW3ZQi3NzXxNtlZnRwdfd9snn9CHpaV8bTaXs2gRgQSeA1sPhRMIYuNHsr8XuPEvwNub7CxvFTt29c9IpTqfpYaSD2Lv6BqDKO%2bQoptuyHmrfLg3mZPlqUy19p656op8yU6aMG8rb33v7CpLtL7xu90VuAtIIMOAy0lCYAntLbW2tEj79%2b2TTrS2SquLiiQkKR2prpa2b90qdZ08KdXW1Eifnz0rVX38sRQkl0uzUlOl3bt2SShAwg5KjceOSSnTpknBgYHcHh3D181dvFgCUdyn%2bfhxaeeOHVJjQ4MEgqT83Fxuw3JAPhLyuc3IMH53yM4kxfFXYfuMBNdDE5fd3ZqSRbqaQJp3aCqdbA%2b8eaMn4PrVUwE/Xu2S/wDcON8S%2bPOVzmA6fTSonfrd%2ba531oaynR9MgIETACC4ISIkxHCys9OwtarKgN0ybCgvN5zq7jYsmDfP8E5iogGJGz7r7TX09vQYNm/aZPD38zOgIwzrysoM6Aa%2bDvOv3LjRAGIM6BzDls2b%2bXpFK1YY2tvaDOXr1hmOHD5sqKyo4M/MDp3DfUEgH4F/3Cfg1hr%2bnznZMZ2ak7DzzeUzlq5X30qvCfh5w2HFz/quAMPVU3L6slN%2b90qH/O4XbXLpSjue2/zP3znrO5zfGbVRxrNvJGAMdoY4EIiN2rg4QgJUWlxMu3bupGK0OmvrwmXLKCw4mJK0WlqxfDmtZCgspFy0bXhICJWXldF8nY77smO1tqSEDuzbR6tWriTcB3TwwAFuMz0piTZXVvKjM3vmTO6zIDubQDolIvb9fABWPIuHPMtkPxU7ij8IfCCjZH6UZWndvs9m7Ake3nIsaPjXXfLhX3TIhw20yYf1t8qHXm7xt7nQ5D%2b89VMFPxaNh9W86CXrsk3/EMI%2bdrQgJJGPSiUHukCLXdX6enlp38KIttQG%2bvtrQY4WFxeXA956iyMkKIjbJ4g5tg4D85vg6akNhA3eBlqvsWO1k319tbgEtZN9fLQTxo3j66JjtKEKBV/bGN%2b4BpDAvjkAN57wnikFfMwri5W1vFRu9rDvVJDBbftb/QH5b/8nqv/D7592V6DcjEdt0gAAAABJRU5ErkJggg==' /%3e%3c/svg%3e" width="2560" data-src="/assets/static/logo-bpm.42db587.f97ece4bf4f73c341740a2eef50c0679.png" data-srcset="/assets/static/logo-bpm.82a2fbd.f97ece4bf4f73c341740a2eef50c0679.png 480w, /assets/static/logo-bpm.cbab2cf.f97ece4bf4f73c341740a2eef50c0679.png 1024w, /assets/static/logo-bpm.2665e34.f97ece4bf4f73c341740a2eef50c0679.png 1920w, /assets/static/logo-bpm.42db587.f97ece4bf4f73c341740a2eef50c0679.png 2560w" data-sizes="(max-width: 2560px) 100vw, 2560px" class="g-image g-image--lazy g-image--loading" style="width:200px;"><noscript><img src="/assets/static/logo-bpm.42db587.f97ece4bf4f73c341740a2eef50c0679.png" class="g-image g-image--loaded" width="2560"></noscript></a></div><div class="w-full px-2 sm:px-4 max-w-screen-xs"><!----></div><div class="flex items-center justify-end px-2 sm:px-4"><!----><!----><!----><button aria-label="Toggle Darkmode" title="Toggle Darkmode" class="ml-2 sm:ml-8"><svg xmlns="http://www.w3.org/2000/svg" width="1.5em" height="1.5em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></button></div></div></div></div></header><main class="container relative flex flex-wrap justify-start flex-1 w-full bg-ui-background"><!----><div class="w-full pb-24"><div class="flex flex-wrap items-start justify-start"><div class="order-2 w-full md:w-1/4 sm:pl-4 md:pl-6 lg:pl-8 sticky" style="top:4rem;"><div class="mt-8 sm:pl-4 md:pl-6 md:pt-12 lg:pl-8 sm:pb-16 sm:border-l border-ui-border md:mt-0"><h3 class="pt-0 mt-0 text-sm tracking-wide uppercase border-none">On this page</h3><div><ul><li class="font-semibold depth-2"><a href="/bpm6-api/bpm6-transaction-listener/#usage-extension" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          Usage Extension
        </a></li></ul></div></div></div><div class="order-1 w-full md:w-3/4"><div class="content"><h1 id="uengine6-transaction-listener"><a href="#uengine6-transaction-listener" aria-hidden="true"><span class="icon icon-link"></span></a>uEngine6 Transaction Listener</h1>
<p>Main interface of ProcessTransactionListener is as follows:</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>uengine<span class="token punctuation">.</span>five</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProcessTransactionListener</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">beforeCommit</span><span class="token punctuation">(</span><span class="token class-name">ProcessTransactionContext</span> tx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">beforeRollback</span><span class="token punctuation">(</span><span class="token class-name">ProcessTransactionContext</span> tx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">afterCommit</span><span class="token punctuation">(</span><span class="token class-name">ProcessTransactionContext</span> tx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">afterRollback</span><span class="token punctuation">(</span><span class="token class-name">ProcessTransactionContext</span> tx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>The transactional management in uEngine6 was reimagined to address performance challenges. Since multiple instances (main processes, sub-processes, and even multiple instances) need to be created and saved within a single transaction, continuously reading and writing process instance states and variable values through JPA Repository with SQL transmissions to the database for every change would cause serious performance degradation. Traditionally, uEngine developed and used its own caching framework for DAOs to mitigate this issue.</p>
<p>In uEngine6, there was a major initiative to replace proprietary technologies with standard Spring-based technologies where possible, so they decided to implement the existing functionality based on JPA.</p>
<p>The goal was to save only the modified process instances at a unique completion point of a single request, capturing just their final state values.</p>
<p>The author, admittedly not very familiar with Spring, tried various methods (including Application Events) but couldn't get them to execute just once properly. Eventually, they created a framework at the service layer where an annotation could be applied, and an advice would filter it to save only the modified instances at the start and completion points:</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/work-item/{taskId}"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@ProcessTransactional</span> <span class="token comment">//important!</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putWorkItem</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"taskId"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> taskId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">WorkItem</span> workItem<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre>
<p>In conclusion, whereas previously you would declare @Transactional in Spring to establish a transaction, now you simply need to add one more declaration: @ProcessTransactional. When declared this way, the following Advice gives registered TransactionListeners the opportunity to receive callbacks for beforeCommit and beforeRollback:</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>uengine<span class="token punctuation">.</span>five</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProcessTransactionAdvice</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"@annotation(org.uengine.five.ProcessTransactional)"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initiateTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"start tx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">ProcessTransactionContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@AfterReturning</span><span class="token punctuation">(</span><span class="token string">"@annotation(org.uengine.five.ProcessTransactional)"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"commit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProcessTransactionContext</span><span class="token punctuation">.</span><span class="token function">getThreadLocalInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@AfterThrowing</span><span class="token punctuation">(</span><span class="token string">"@annotation(org.uengine.five.ProcessTransactional)"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rollbackTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"rollback"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProcessTransactionContext</span><span class="token punctuation">.</span><span class="token function">getThreadLocalInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>The JPAProcessInstance registers itself to the ProcessTransactionContext (which exists as a ThreadLocal object) at the moment of its creation, and then implements a cohesive logic to save itself only once in its final state during the beforeCommit() method:</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>uengine<span class="token punctuation">.</span>five</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JPAProcessInstance</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultProcessInstance</span> <span class="token keyword">implements</span> <span class="token class-name">ProcessTransactionListener</span> <span class="token punctuation">{</span> <span class="token comment">// JPAProcessInstance is a ProcessTransactionListener.</span>

   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">public</span> <span class="token class-name">JPAProcessInstance</span><span class="token punctuation">(</span><span class="token class-name">ProcessDefinition</span> procDefinition<span class="token punctuation">,</span> <span class="token class-name">String</span> instanceId<span class="token punctuation">,</span> <span class="token class-name">Map</span> options<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>procDefinition<span class="token punctuation">,</span> instanceId<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">//Add this instance as transaction listener and register this so that it can be cached.</span>
        <span class="token comment">// When a JPAProcessInstance is created in any way, it registers itself in the ProcessTransactionContext.</span>
        <span class="token class-name">ProcessTransactionContext</span><span class="token punctuation">.</span><span class="token function">getThreadLocalInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTransactionListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProcessTransactionContext</span><span class="token punctuation">.</span><span class="token function">getThreadLocalInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerProcessInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment">//   Just before it is committed, it saves all its modifications at once. It saves to both file and DB.</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">beforeCommit</span><span class="token punctuation">(</span><span class="token class-name">ProcessTransactionContext</span> tx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        processInstanceRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token function">getProcessInstanceEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">IResource</span> resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultResource</span><span class="token punctuation">(</span><span class="token string">"instances/"</span> <span class="token operator">+</span> <span class="token function">getInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resourceManager<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> <span class="token function">getVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="usage-extension"><a href="#usage-extension" aria-hidden="true"><span class="icon icon-link"></span></a>Usage Extension</h2>
<p>If there's a need for application logic implementations (similar to JPAProcessInstance) to receive events once and save cached information only at the final stage, they could be implemented as follows:</p>
<pre class="language-java"><code class="language-java"><span class="token function">executeActivity</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token class-name">ProcessTransactionContext</span><span class="token punctuation">.</span><span class="token function">getThreadLocalInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTransactionListener</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">ProcessTransactionListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
             <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">beforeCommit</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                  <span class="token function">flushSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>

              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
</div><div class="mt-8 pt-8 lg:mt-12 lg:pt-12 border-t border-ui-border"><div><div class="flex flex-col sm:flex-row justify-between items-center"><!----><!----></div></div></div></div></div></div></main></div><!----></div>
    <script src="/assets/js/app.7af9b39f.js" defer></script><script src="/assets/js/page--src-templates-markdown-page-vue.11b18f2f.js" defer></script>
  </body>
</html>
